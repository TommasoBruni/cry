#include "test.h"
#include <cry/crc.h>

#define MSG "ABCDEFGHIJKLMNOPQRSTUVWXYZ"

static void crc16_ccitt_test(void)
{
    uint16_t crc;
#define CRC16_CCITT 0xad3b

    crc = cry_crc16_ccitt(MSG, strlen(MSG));
    TRACE("crc16-ccitt = 0x%04x\n", crc);
    ASSERT_EQ(crc, CRC16_CCITT);
}

static void crc16_ibm_test(void)
{
    uint16_t crc;
#define CRC16_IBM   0xfe85

    crc = cry_crc16_ibm(MSG, strlen(MSG));
    TRACE("crc16-ibm   = 0x%04x\n", crc);
    ASSERT_EQ(crc, CRC16_IBM);
}

static const unsigned char en_60870_5_1_pattern[] = {
    0x00, 0x00, 0x00, 0x28, 0x30, 0x00, 0x3B, 0xE1,
    0x58, 0x0F, 0x12, 0xA7, 0x46, 0x1B, 0x01, 0x00,
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00
};

struct binary_test {
    char*           name;
    unsigned char*  pattern;
    size_t          pattern_size;
    unsigned short  expected;
};

static const struct binary_test brs[] = {
    {
        "CEI EN 60870-5-1 ref pattern",
        en_60870_5_1_pattern, sizeof(en_60870_5_1_pattern),
        0xea02
    }
};

static void crc16_dnp_test(void)
{
    struct tsc_crc16_ctx ctx;
    int i, t;
    unsigned short crc;
    
    printf("\nCTR (DNP, CEI EN 60870-5-1)\n");

    for(t = 0; t < sizeof(brs)/sizeof(*brs); ++t) {
        printf("CRC16(%s) = 0x%04x\n", brs[t].name,
            tsc_crc16_dnp(brs[t].pattern, brs[t].pattern_size));

        printf("CRC16(");
        tsc_crc16_dnp_init(&ctx);
        for (i = 0; i < brs[t].pattern_size; i++) {
            printf("%02x ", brs[t].pattern[i]);
            tsc_crc16_update(&ctx, &brs[t].pattern[i], 1);
        }
        tsc_crc16_final(&ctx, &crc);
        printf(") = 0x%04x\n", crc);
    }
}

static void crc32_eth_test(void)
{
    uint32_t crc;
#define CRC32_ETH   0Xabf77822

    crc = cry_crc32_eth(MSG, strlen(MSG));
    TRACE("crc32-eth   = 0x%08x\n", crc);
    ASSERT_EQ(crc, CRC32_ETH);
}

void crc_test(void)
{
    TRACE("msg: %s\n", MSG);
    RUN(crc16_ccitt_test);
    RUN(crc16_ibm_test);
    RUN(crc16_dnp3_test);
    RUN(crc32_eth_test);
}
